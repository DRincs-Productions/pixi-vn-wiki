---
title: Altre caratteristiche narrative
description: Covers additional narrative features in Pixi'VN, including end-of-game handling, error management, and random number generation.
---

import { Accordion, Accordions } from 'fumadocs-ui/components/accordion';

<Accordions>

<Accordion title="Managing the end of the game" id="managing-the-end-of-the-game">

Quando tutti i `passaggi` di tutte le `etichette` saranno stati eseguiti, il gioco si fermerà. Lo sviluppatore è responsabile della gestione del finale del gioco, poiché le visual novel possono avere diverse strategie di conclusione:

- The game ends when all `steps` are executed.
- The game has no end; if the `steps` are finished, it is considered an error and should be handled.
- The game ends when the player reaches a specific point, such as a game over screen.

To manage the end of the game, set `Game.onEnd`. This function is called when the game ends and has the same signature as a `step`.

For example, to end the game and navigate to an end screen:

```ts title="main.ts"
import { Game } from '@drincs/pixi-vn'

Game.onEnd(async (props) => {
    props.navigate("/end")
})
```

If your game has no end and should restart or loop:

```ts title="labels/startLabel.ts"
export const startLabel = newLabel("start_label_id",
    () => {
        return [
            // ...
        ]
    }
)
```

```ts title="main.ts"
import { Game } from '@drincs/pixi-vn'

Game.onEnd(async (props) => {
    narration.call(startLabel, props)
})
```

</Accordion>

<Accordion title="Handling step errors" id="handling-step-errors">

Se si verifica un errore in un `passaggio`, il gioco registra un errore sulla console e interrompe l'esecuzione dei passaggi successivi. Lo sviluppatore dovrebbe gestire gli errori impostando `Game.onError`.

Ad esempio, per inviare una notifica quando si verifica un errore:

```ts title="main.ts"
import { Game } from '@drincs/pixi-vn'

Game.onError((type, error, { notify }) => {
    notify("An error occurred")
    // Optionally send the error to GlitchTip, Sentry, etc.
})
```

</Accordion>

<Accordion title="Random number generation" id="random-number-generation">

Pixi’VN include una funzione integrata per generare numeri casuali. Use `narration.getRandomNumber()` with the following parameters:

- `min`: Il valore minimo.
- `max`: Il valore massimo.
- `options` (Optional):
  - `onceonly`: If `true`, the number will be generated only once for the current `step` of the `label` (default: `false`). Note: `min` and `max` affect the storage of already generated numbers.

</Accordion>

<Accordion title="Check if the label has already been completed" id="check-if-the-label-has-already-been-completed">

To check if a `label` has already been completed, use the `narration.isLabelAlreadyCompleted` function.
Questa funzione ha i seguenti parametri:

- `label`: The <DynamicLink href="/start/labels">label</DynamicLink> to check.

```typescript
const isLabelCompleted = narration.isLabelAlreadyCompleted(startLabel)
const isLabelCompleted = narration.isLabelAlreadyCompleted("labelid")
```

</Accordion>

<Accordion title="Get already made choices of current step" id="get-already-been-made-choices-of-current-step">

To get the choices already made in the current `step`, use `narration.alreadyCurrentStepMadeChoices`.

```typescript
const choices = narration.alreadyCurrentStepMadeChoices
```

</Accordion>

<Accordion title="Check if current step has already been opened" id="check-if-current-step-is-already-been-opened">

To check if the current `step` has already been opened, use `narration.isCurrentStepAlreadyOpened`.

```typescript
const isCurrentStepOpened = narration.isCurrentStepAlreadyOpened;
```

</Accordion>

<Accordion title="Counter of execution times of the current step" id="counter-of-execution-times-of-the-current-step">

To get the execution count for the current `step`, use `narration.currentStepTimesCounter`.\
**Important:** The counter is incremented only if `narration.currentStepTimesCounter` is accessed at least once in a `step`.

```ts title="labels/startLabel.ts"
export const label = newLabel("id",
    () => {
        if (narration.currentStepTimesCounter === 0) { // ✅ will be incremented
            // ...
        } else {
            // ...
        }
    }
)
```

```ts title="labels/startLabel.ts"
export const label = newLabel("id",
    () => {
        if (narration.currentStepTimesCounter === 0) { // ✅ will be incremented
            // ...
        } else if (narration.currentStepTimesCounter === 1) { // ✅ Not incremented again in this step
            // ...
        }
    }
)
```

```ts title="labels/startLabel.ts"
export const label = newLabel("id",
    () => {
        if (flag) {
            if (narration.currentStepTimesCounter === 1) { // ❌ Only incremented if "flag" is true
                // ...
            }
        }
    }
)
```

To reset the execution counter for the current `step`, set `narration.currentStepTimesCounter = 0`.

```typescript
narration.currentStepTimesCounter = 0;
```

</Accordion>

</Accordions>
